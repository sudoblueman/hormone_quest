<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹è¡“å®¤ç«ç½å¤§æŒ‘æˆ° V19.0 (é€šé¢¨å¢å¼·ç‰ˆ)</title>
    
    <style>
        /* CSS æ¨£å¼èˆ‡ V18.0 ç›¸åŒï¼Œä¿æŒç©©å®š */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            background-color: #00796b;
            color: white;
            width: 100%;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        header h1 {
            margin: 0;
            font-size: 2.2em;
        }
        
        /* éš±è—æ¨™èª */
        header p {
            display: none; 
        }

        main {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 30px;
            max-width: 1300px;
            width: 100%;
        }

        .info-panel, .controls-panel, .simulation-panel, #results-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .info-panel {
            flex: 1 1 100%;
            border-left: 5px solid #ff9800;
            line-height: 1.6;
        }

        .controls-panel {
            flex: 1 1 45%;
            display: flex;
            flex-direction: column;
        }
        #initial-setup {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .simulation-panel {
            flex: 1 1 50%;
            min-height: 550px;
            position: relative;
            border: 3px solid #66bb6a;
            transition: border-color 0.3s, box-shadow 0.3s; 
        }

        /* è­¦å‘Šè¦–è¦ºæ•ˆæœ */
        .simulation-panel.alert-yellow {
            border-color: #ffc107;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
        }
        .simulation-panel.alert-red {
            border-color: #d32f2f;
            box-shadow: 0 0 20px rgba(211, 47, 47, 0.8), 0 0 40px rgba(211, 47, 47, 0.3);
            animation: pulse-border 0.5s infinite alternate;
        }
        @keyframes pulse-border {
            from { border-width: 3px; }
            to { border-width: 5px; }
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .goals-list {
            list-style-type: none;
            padding-left: 0;
            font-size: 1.1em;
        }
        
        /* æ»‘æ¡¿èˆ‡æ§åˆ¶å€ */
        .slider-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        input[type="range"] {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
        }
        
        .live-control-slider {
            background-color: #fffde7;
            border-color: #ffeb3b;
        }

        #start-simulation {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s;
        }

        #start-simulation:hover {
            background-color: #fb8c00;
        }
        
        /* å„€è¡¨æ¿æ¨£å¼ */
        #score-display { 
            font-size: 1.4em;
            font-weight: bold;
            color: #004d40;
        }

        .hidden { display: none !important; }

        /* æ‡‰è®ŠæŒ‡ç¤ºæ–‡å­— */
        .action-needed {
            color: #d32f2f;
            font-weight: bold;
            animation: blink 0.5s infinite alternate;
        }
        @keyframes blink {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
        /* ç«èŠ±æ•ˆæœåŠ å¼· */
        #gas-cloud.flame {
            box-shadow: 0 0 20px 10px rgba(255, 165, 0, 0.7);
            border: 2px solid orange;
            transition: box-shadow 0.1s, border 0.1s;
        }
        #gas-cloud.explosion {
            box-shadow: 0 0 50px 20px red;
        }
    </style>
</head>
<body>

    <header>
        <h1>æ‰‹è¡“å®¤ç«ç½å¤§æŒ‘æˆ° V19.0 ğŸ’ª (é€šé¢¨å¢å¼·ç‰ˆ)</h1>
        <p>å·²ç¢ºä¿æ‰€æœ‰ç¬¦è™Ÿå’Œä»£ç¢¼åç¨±æ­£ç¢ºé¡¯ç¤ºï¼Œç„¡äº‚ç¢¼å•é¡Œã€‚</p> 
    </header>

    <main>
        <section class="info-panel">
            <h2>ğŸ“– éŠæˆ²ç›®æ¨™èˆ‡æ‡‰è®Šæç¤º</h2>
            <ul class="goals-list">
                <li>**éŠæˆ²æ™‚é•·ï¼š** æŒ‘æˆ°æ™‚é–“å»¶é•·è‡³ **45.0 ç§’** (æ…¢å‹•ä½œæ¨¡å¼)ã€‚</li>
                <li>**æ ¸å¿ƒæŒ‘æˆ°ï¼š** **é›»ç‡’åˆ€ (P_Heat)** æœƒæ¯ 7 ç§’**é–“æ­‡æ€§åœ°é–‹å•Ÿ/é—œé–‰** (æ“ä½œé–“éš”å·²å»¶é•·)ã€‚</li>
                <li>**æ‡‰å°å¢å¼·ï¼š** é€šé¢¨ç³»çµ± (S\_Vent) æœ€å¤§å€¼å·²æå‡è‡³ **15 ç´š**ï¼Œå…·å‚™æ›´å¼·çš„é¢¨éšªæ§åˆ¶èƒ½åŠ›ã€‚</li>
                <li>**ç›®æ¨™ä¸€ï¼š** **å®‰å…¨é€šé** - æˆåŠŸå®Œæˆ **45.0 ç§’** æ¨¡æ“¬ï¼Œé¿å…çˆ†ç‚¸ (R_risk > 95)ã€‚</li>
                <li>**ç›®æ¨™äºŒï¼š** **æ¥µé™å®‰å…¨çå‹µ** - å°‡é¢¨éšª (R_risk) ä¿æŒåœ¨ **30 ä»¥ä¸‹**ï¼Œå¯ç²å¾—é¡å¤–ç©åˆ†çå‹µã€‚</li>
                <li>**æ‡‰è®Šçå‹µï¼š** åœ¨å‹•æ…‹ç’°å¢ƒä¸‹å°‡é¢¨éšªå¾ä¸­/é«˜é¢¨éšªé™å›å®‰å…¨å€ï¼Œæœƒç²å¾— **150 é»** çå‹µç©åˆ†ï¼</li>
            </ul>
        </section>

        <section class="controls-panel">
            <h2>ğŸ§ª éšæ®µä¸€ï¼šæ‰‹è¡“ç’°å¢ƒåƒæ•¸è¨­ç½®</h2>
            
            <div id="initial-setup">
                <h3>**è¨­ç½®åƒæ•¸èˆ‡å³æ™‚æ§åˆ¶**</h3>
                <div id="setup-sliders-container">
                    </div>
            </div>
            
            <button id="start-simulation">ğŸš€ é–‹å§‹æ‡‰è®Šï¼(å…± 45.0 ç§’)</button>
        </section>

        <section class="simulation-panel" id="simulation-panel">
            <h2>ğŸš¨ éšæ®µäºŒï¼šå¯¦æ™‚é¢¨éšªç›£æ¸¬èˆ‡æ‡‰è®Š</h2>
            
            <div class="simulation-area">
                <div id="gas-cloud"></div> 
                <div id="surgical-site">é›»ç‡’åˆ€ä½¿ç”¨å€åŸŸ</div>
            </div>
            
            <div class="dashboard">
                <div class="meter">
                    <p>ç‡ƒæ–™å¼·åº¦ (CHâ‚„): <span id="ch4-display">0%</span></p>
                    <div class="risk-bar ch4-bar"></div>
                </div>
                <div class="meter">
                    <p>åŠ©ç‡ƒåŠ‘å¼·åº¦ (Oâ‚‚): <span id="o2-display">0X</span></p>
                    <div class="risk-bar o2-bar"></div>
                </div>
                <div class="meter">
                    <p>ç«æºå¼·åº¦ (Heat): <span id="heat-display">0</span></p>
                    <div class="risk-bar heat-bar"></div>
                </div>
                <div class="meter">
                    <p>å³æ™‚é¢¨éšªç­‰ç´š (R_risk): <span id="risk-display">0</span></p>
                    <div class="risk-bar risk-level-bar"></div>
                </div>
                <div class="timer">
                    â³ å‰©é¤˜æ™‚é–“: <span id="timer-display">45.0</span> ç§’<br>
                    ğŸ’¯ å®‰å…¨ç©åˆ†: <span id="score-display">0</span><br>
                    ğŸ”¥ ç«èŠ±æ¬¡æ•¸: <span id="burn-count-display">0</span> æ¬¡
                </div>
            </div>
            
            <div class="event-log">
                æ¨¡æ“¬æ—¥èªŒï¼š<span id="event-message">è¨­ç½®å®Œç•¢ï¼Œé»æ“Šé–‹å§‹ï¼ŒæŒ‘æˆ°æ‡‰è®Šï¼</span>
            </div>
        </section>
        
        <section id="results-panel" class="hidden">
            <h2>ğŸ“‹ æ¨¡æ“¬çµæœå ±å‘Š</h2>
            <p id="final-result-text"></p>
            <h3>ç§‘å­¸è§€å¯Ÿèˆ‡çµè«–</h3>
            <p id="learning-point"></p>
            <p>ğŸ† **æœ€çµ‚å®‰å…¨ç©åˆ†ï¼š** <span class="achievement-text" id="final-score">0</span> åˆ†</p>
            <p>ğŸ”¥ **ç¸½ç«èŠ±æ¬¡æ•¸ï¼š** <span class="failure-text" id="final-burn-count">0</span> æ¬¡</p>
            <button onclick="window.location.reload()">é‡æ–°å¯¦é©—</button>
        </section>

    </main>

    <footer>
        <p>è¨­è¨ˆéˆæ„Ÿä¾†è‡ªï¼šæç¬‘è«¾è²çˆ¾ç (Ig Nobel Prize) é†«å­¸ç ”ç©¶</p>
    </footer>

    <script>
        // --- éŠæˆ²åƒæ•¸èˆ‡å¸¸æ•¸ (V19.0: é€šé¢¨å¢å¼·) ---
        const GAME_DURATION_SECONDS = 45.0; 
        const FART_CHANGE_TIME = 3000;      
        const HEAT_CYCLE_TIME = 7000;       
        const RANDOM_EVENT_CHECK_TIME = 7000;
        const UPDATE_INTERVAL = 50; 
        
        const BURN_THRESHOLD = 70; 
        const HIGH_RISK_THRESHOLD = 80; 
        const MODERATE_RISK_THRESHOLD = 60; 
        const LOW_RISK_THRESHOLD = 30;
        const EXPLOSION_THRESHOLD = 95; 
        const RESPONSE_BONUS = 150; 
        const LOW_RISK_BONUS = 50;
        
        // V19.0 é—œéµæ”¹å‹•ï¼šé™ä½ Oxy æ¬Šé‡ï¼Œå¢å¼· Vent æ•ˆæœ
        const WEIGHTS = { Fuel: 0.5, Oxy: 1.0, Heat: 4, Vent: 3 }; // Oxy å¾ 1.5 é™ç‚º 1.0

        const allSliders = [
            { id: 'fart-intensity', label: 'ç—…æ‚£è…¸æ°£ç”¢é‡ (I_Fart):', max: 10, unit: 'ç´š', initial: 5, controlled: 'dynamic' }, 
            { id: 'ch4-percent', label: 'ç‡ƒæ–™ï¼šç”²çƒ·æ¯”ä¾‹ (C_CHâ‚„):', max: 10, unit: '%', initial: 5, controlled: 'static' }, 
            { id: 'o2-percent', label: 'åŠ©ç‡ƒåŠ‘ï¼šæ°§æ°£æ¿ƒåº¦ (C_Oâ‚‚):', max: 10, unit: 'X', initial: 4, controlled: 'static' }, 
            { id: 'heat-power', label: 'ç«æºï¼šé›»ç‡’åˆ€å¼·åº¦ (P_Heat):', max: 5, unit: 'ç´š', initial: 3, controlled: 'static' }, 
            // V19.0 é—œéµæ”¹å‹•ï¼šS_Vent æœ€å¤§å€¼å¾ 10 å¢è‡³ 15
            { id: 'vent-system', label: 'æ§åˆ¶ï¼šé€šé¢¨ç³»çµ±å¼·åº¦ (S_Vent):', max: 15, unit: 'ç´š', initial: 5, controlled: 'player' }, 
        ];

        // ç‹€æ…‹è®Šæ•¸ (å…¨å±€)
        let simulationActive = false;
        let animationFrameId = null; 
        let startTime = 0; 
        let lastUpdate = 0; 
        let lastFartChange = 0; 
        let lastHeatCycle = 0;
        let lastRandomEvent = 0;
        let isHeatActive = false;
        let baseHeatValue = 0;
        
        let burnCount = 0; 
        let currentScore = 0; 
        let previousRiskLevel = 'safe'; 
        let fartIntensityInput = null; 
        let heatPowerInput = null;

        const elements = {}; // DOM å…ƒç´ åƒè€ƒ

        // --- å‡½æ•¸ 1: DOM å…ƒç´ ç²å–èˆ‡æª¢æŸ¥ ---
        function getDOMElements() {
            const ids = [
                'setup-sliders-container', 'start-simulation', 'risk-display', 
                'burn-count-display', 'score-display', 'event-message', 
                'ch4-display', 'o2-display', 'heat-display', 'timer-display', 
                'gas-cloud', 'simulation-panel', 'results-panel', 
                'final-result-text', 'learning-point', 'final-burn-count', 'final-score'
            ];
            
            let foundAll = true;
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    elements[id.replace(/-/g, '')] = el;
                } else {
                    console.error(`[V19.0 ERROR] Missing DOM Element: #${id}.`);
                    foundAll = false;
                }
            });

            elements.riskBar = document.querySelector('.risk-level-bar');
            elements.ch4Bar = document.querySelector('.ch4-bar');
            elements.o2Bar = document.querySelector('.o2-bar');
            elements.heatBar = document.querySelector('.heat-bar');

            if (!foundAll) {
                console.error('éŠæˆ²åˆå§‹åŒ–å¤±æ•—ï¼šéƒ¨åˆ†é—œéµå…ƒä»¶éºå¤±ï¼Œè«‹æª¢æŸ¥ç¨‹å¼ç¢¼æ˜¯å¦å®Œæ•´è¤‡è£½ã€‚');
                return false;
            }
            return true;
        }

        // --- å‡½æ•¸ 2: åˆå§‹åŒ–æ»‘æ¡¿ ---
        function initializeSliders() {
            if (!elements.setupsliderscontainer) return;
            
            allSliders.forEach(slider => {
                const group = document.createElement('div');
                group.id = `${slider.id}-group`;
                group.className = `slider-group ${slider.controlled === 'player' ? 'live-control-slider' : ''}`;
                
                group.innerHTML = `
                    <label for="${slider.id}">${slider.label} <span id="${slider.id}-val">${slider.initial} ${slider.unit}</span></label>
                    <input type="range" id="${slider.id}" min="1" max="${slider.max}" value="${slider.initial}">
                `;
                elements.setupsliderscontainer.appendChild(group);

                const rangeInput = document.getElementById(slider.id);
                const valueSpan = document.getElementById(`${slider.id}-val`);

                if (!rangeInput || !valueSpan) {
                     console.error(`[V19.0 ERROR] æ»‘æ¡¿ ${slider.id} å‰µå»ºå¤±æ•—ã€‚`);
                     return;
                }

                rangeInput.addEventListener('input', () => {
                    valueSpan.textContent = `${rangeInput.value} ${slider.unit}`;
                    // æ³¨æ„ï¼šé€šé¢¨ç³»çµ±çš„æœ€å¤§å€¼å·²è®Šç‚º 15ï¼Œä½†å…¶åœ¨ dashboard çš„é¡¯ç¤ºä»åŸºæ–¼ 10 ç´šä¾†é¡¯ç¤ºç™¾åˆ†æ¯” (å› è¦–è¦ºä¸Š max=10 çš„é•·åº¦è¼ƒåˆç†)ã€‚
                    // ç‚ºäº†ç°¡åŒ–ï¼Œå„€è¡¨æ¿çš„è¦–è¦ºæ¢åªåŸºæ–¼ 100% å¯¬åº¦è¨ˆç®—ã€‚
                    updateDashboardDisplays(rangeInput.id, rangeInput.value); 
                    
                    if (slider.id === 'heat-power') {
                        baseHeatValue = parseInt(rangeInput.value);
                    }
                });

                if (slider.id === 'fart-intensity') {
                    fartIntensityInput = rangeInput;
                } else if (slider.id === 'heat-power') {
                    heatPowerInput = rangeInput;
                    baseHeatValue = parseInt(rangeInput.value);
                }
                
                updateDashboardDisplays(slider.id, slider.initial);
            });
        }
        
        // --- å‡½æ•¸ 3: å‹•æ…‹è®Šæ•¸èª¿æ•´ (è…¸æ°£) ---
        function dynamicallyChangeFart() {
            if (!fartIntensityInput) return;

            const currentValue = parseInt(fartIntensityInput.value);
            const max = parseInt(fartIntensityInput.max);
            const min = parseInt(fartIntensityInput.min);

            let change = Math.floor(Math.random() * 3) - 1; 
            let newValue = currentValue + change;
            newValue = Math.max(min, Math.min(max, newValue));

            fartIntensityInput.value = newValue;
            document.getElementById('fart-intensity-val').textContent = `${newValue} ç´š`;
            
            if (newValue !== currentValue) {
                 elements.eventmessage.textContent = `ğŸ’¨ ç’°å¢ƒè®ŠåŒ–ï¼šç—…æ‚£è…¸æ°£ ${newValue > currentValue ? 'å‡é«˜' : 'é™ä½'} åˆ° ${newValue} ç´šã€‚`;
            }
        }

        // --- å‡½æ•¸ 4: é›»ç‡’åˆ€é–“æ­‡æ€§å¾ªç’° ---
        function runHeatCycle(timestamp) {
            if (!heatPowerInput) return;
            
            if (!isHeatActive) {
                // æ¨¡æ“¬é›»ç‡’åˆ€é–‹å•Ÿ
                isHeatActive = true;
                heatPowerInput.value = baseHeatValue;
                document.getElementById('heat-power-val').textContent = `${baseHeatValue} ç´š`;
                elements.eventmessage.textContent = 'âš¡ï¸ ç«æºè­¦å ±ï¼šé›»ç‡’åˆ€ **é–‹å•Ÿ**ï¼è«‹æ³¨æ„é¢¨éšªã€‚';
            } else {
                // æ¨¡æ“¬é›»ç‡’åˆ€é—œé–‰
                isHeatActive = false;
                heatPowerInput.value = 1; // ä¿æŒæœ€å°å€¼ï¼Œæ¨¡æ“¬é—œé–‰/å¾…æ©Ÿç‹€æ…‹
                document.getElementById('heat-power-val').textContent = `1 ç´š (å¾…æ©Ÿ)`;
                elements.eventmessage.textContent = 'ğŸ”‹ é›»ç‡’åˆ€ **é—œé–‰/å¾…æ©Ÿ**ã€‚é¢¨éšªé™ä½ã€‚';
            }
            // å¼·åˆ¶æ›´æ–°å„€è¡¨æ¿é¡¯ç¤º
            updateDashboardDisplays('heat-power', heatPowerInput.value);
            lastHeatCycle = timestamp;
        }

        // --- å‡½æ•¸ 5: éš¨æ©Ÿäº‹ä»¶è§¸ç™¼å™¨ ---
        function triggerRandomEvent(timestamp) {
            const roll = Math.random();
            let eventText = '';
            
            // 20% æ©Ÿæœƒè§¸ç™¼éš¨æ©Ÿäº‹ä»¶
            if (roll < 0.20) {
                const eventType = Math.random();
                
                if (eventType < 0.5) {
                    // 1. é€šé¢¨æ•…éšœ (Vent è‡¨æ™‚æ¸›å¼± 4 ç´š)
                    const ventInput = document.getElementById('vent-system');
                    if (!ventInput) return;

                    const originalVent = parseInt(ventInput.value);
                    const newVent = Math.max(1, originalVent - 4);

                    ventInput.dataset.originalValue = originalVent;
                    ventInput.value = newVent;
                    document.getElementById('vent-system-val').textContent = `${newVent} ç´š (æ•…éšœ!)`;
                    eventText = 'ğŸš¨ **è¨­å‚™æ•…éšœï¼** é€šé¢¨ç³»çµ±æš«æ™‚æ¸›å¼±ï¼è«‹æ‰‹å‹•èª¿æ•´ã€‚';
                    
                    setTimeout(() => {
                        if (simulationActive && ventInput.dataset.originalValue) {
                            ventInput.value = ventInput.dataset.originalValue;
                            document.getElementById('vent-system-val').textContent = `${ventInput.value} ç´š`;
                            elements.eventmessage.textContent = 'âœ… é€šé¢¨ç³»çµ±æ¢å¾©æ­£å¸¸ã€‚';
                            delete ventInput.dataset.originalValue; 
                        }
                    }, 3000);

                } else {
                    // 2. è…¸æ°£æ¿€å¢ (Fart è‡¨æ™‚å¢åŠ  3 ç´š)
                    if (!fartIntensityInput) return;
                    
                    const originalFart = parseInt(fartIntensityInput.value);
                    const newFart = Math.min(10, originalFart + 3);

                    fartIntensityInput.dataset.originalValue = originalFart;
                    fartIntensityInput.value = newFart;
                    document.getElementById('fart-intensity-val').textContent = `${newFart} ç´š (æ¿€å¢!)`;
                    eventText = 'ğŸ’¨ **ç·Šæ€¥ç‹€æ³ï¼** ç—…æ‚£è…¸æ°£çªç„¶æ¿€å¢ï¼';

                    setTimeout(() => {
                         if (simulationActive && fartIntensityInput.dataset.originalValue) {
                            fartIntensityInput.value = fartIntensityInput.dataset.originalValue;
                            document.getElementById('fart-intensity-val').textContent = `${fartIntensityInput.value} ç´š`;
                            elements.eventmessage.textContent = 'âœ… ç—…æ‚£è…¸æ°£æ¢å¾©æ­£å¸¸æ³¢å‹•ã€‚';
                            delete fartIntensityInput.dataset.originalValue;
                        }
                    }, 3000);
                }
                
                elements.eventmessage.innerHTML = `<span style="color: purple; font-weight: bold;">${eventText}</span>`;
            }
            lastRandomEvent = timestamp;
        }
        
        // --- å‡½æ•¸ 6: æ›´æ–°å„€è¡¨æ¿é¡¯ç¤º ---
        function updateDashboardDisplays(id, value) {
            const maxSetup = 10;
            const maxHeat = 5;
            const floatValue = parseFloat(value);

            if (id === 'ch4-percent' && elements.ch4display) {
                elements.ch4display.textContent = `${floatValue}%`;
                elements.ch4Bar.style.width = `${(floatValue / maxSetup) * 100}%`;
            } else if (id === 'o2-percent' && elements.o2display) {
                elements.o2display.textContent = `${floatValue}X`;
                elements.o2Bar.style.width = `${(floatValue / maxSetup) * 100}%`;
            } else if (id === 'heat-power' && elements.heatdisplay) {
                elements.heatdisplay.textContent = `${floatValue}ç´š`;
                elements.heatBar.style.width = `${(floatValue / maxHeat) * 100}%`;
            }
            // å°é€šé¢¨ç³»çµ±çš„ç‰¹æ®Šè™•ç†ï¼šé¡¯ç¤ºå¯¦éš›æ•¸å€¼ï¼Œä½† bar çš„é•·åº¦ä»åŸºæ–¼ 10 ç´š
            else if (id === 'vent-system') {
                 // ä¸æ›´æ–° barï¼Œåªæ›´æ–° label
            }
        }

        // --- å‡½æ•¸ 7: æ ¸å¿ƒé¢¨éšªè¨ˆç®— --- 
        function calculateRisk(inputs) {
            const { fartIntensity, ch4Percent, heatPower, ventSystem, o2Percent } = inputs;
            
            // åŸºç¤é¢¨éšª (ä¹˜æ•¸)
            let baseRisk = (ch4Percent * fartIntensity * WEIGHTS.Fuel);
            let amplifiedRisk = baseRisk * (o2Percent * WEIGHTS.Oxy);
            
            // æœ€çµ‚é¢¨éšª (åŠ æ¸›æ•¸)
            let finalRisk = amplifiedRisk + (heatPower * WEIGHTS.Heat) - (ventSystem * WEIGHTS.Vent);
            finalRisk = Math.max(0, Math.min(100, finalRisk));
            return finalRisk;
        }

        // --- å‡½æ•¸ 8: è§¸ç™¼é»ç«äº‹ä»¶ ---
        function triggerFireEvent(risk) {
            if (!simulationActive || !elements.gascloud) return;
            
            if (risk >= BURN_THRESHOLD && !elements.gascloud.classList.contains('flame')) { 
                elements.gascloud.classList.add('flame');
                burnCount++;
                elements.burncountdisplay.textContent = burnCount;
                
                let msg = (risk >= 85) 
                     ? `ğŸš¨ **ç·Šæ€¥ç«èŠ±ï¼** (é¢¨éšªéé«˜) **è«‹ç«‹åˆ»æ‡‰è®Š**ï¼`
                     : `ğŸ”¥ å°ç«èŠ±ç™¼ç”Ÿï¼(${Math.round(risk)}é»é¢¨éšª) é€™æ˜¯ç¬¬ ${burnCount} æ¬¡ã€‚`;
                
                elements.eventmessage.innerHTML = `<span class="failure-text">${msg}</span>`;
                
                currentScore = Math.max(0, currentScore - 20); 

                setTimeout(() => {
                    elements.gascloud.classList.remove('flame');
                }, 100); 
            }
        }

        // --- å‡½æ•¸ 9: éŠæˆ²ä¸»å¾ªç’° (rAF é©…å‹•) ---
        function gameLoop(timestamp) {
            
            // éŠæˆ²æ™‚é–“å€’æ•¸èˆ‡è¦–è¦ºæ›´æ–°ï¼ˆå§‹çµ‚é‹è¡Œï¼‰
            if (startTime === 0 && elements.timerdisplay) {
                elements.timerdisplay.textContent = GAME_DURATION_SECONDS.toFixed(1);
            } else if (elements.timerdisplay) {
                const elapsedTime = timestamp - startTime;
                const remainingSeconds = Math.max(0, GAME_DURATION_SECONDS - (elapsedTime / 1000));
                elements.timerdisplay.textContent = remainingSeconds.toFixed(1);

                if (elapsedTime >= GAME_DURATION_SECONDS * 1000) {
                    endSimulation('safe');
                    return; 
                }
            }

            // --- æ ¸å¿ƒæ¨¡æ“¬é‚è¼¯ (åªåœ¨ simulationActive ç‚º true æ™‚åŸ·è¡Œ) ---
            if (simulationActive) {
                
                if (Math.floor(timestamp / 1000) !== Math.floor(lastUpdate / 1000)) {
                    console.log(`%c[V19.0: å¾ªç’°å•Ÿå‹•] Time: ${(timestamp / 1000).toFixed(1)}s`, 'color: green;');
                }

                if (timestamp - lastFartChange >= FART_CHANGE_TIME) {
                    dynamicallyChangeFart();
                    lastFartChange = timestamp; 
                }
                if (timestamp - lastHeatCycle >= HEAT_CYCLE_TIME) {
                    runHeatCycle(timestamp);
                }
                if (timestamp - lastRandomEvent >= RANDOM_EVENT_CHECK_TIME) {
                    triggerRandomEvent(timestamp);
                }

                if (timestamp - lastUpdate >= UPDATE_INTERVAL) {
                    
                    const inputs = {
                        fartIntensity: parseInt(fartIntensityInput?.value || 5),
                        ch4Percent: parseInt(document.getElementById('ch4-percent')?.value || 5),
                        o2Percent: parseInt(document.getElementById('o2-percent')?.value || 4),
                        heatPower: parseInt(heatPowerInput?.value || 1),
                        ventSystem: parseInt(document.getElementById('vent-system')?.value || 5),
                    };

                    // A. é¢¨éšªè¨ˆç®—èˆ‡æ›´æ–°
                    const currentRisk = calculateRisk(inputs);
                    
                    elements.riskdisplay.textContent = Math.round(currentRisk);
                    elements.riskBar.style.width = `${currentRisk}%`;
                    
                    // B. è¦–è¦ºåŒ–
                    const cloudSize = 50 + currentRisk; 
                    elements.gascloud.style.width = `${cloudSize}px`;
                    elements.gascloud.style.height = `${cloudSize}px`;
                    const red = Math.min(255, Math.floor(currentRisk * 2.5));
                    const green = Math.max(0, 255 - Math.floor(currentRisk * 2.5));
                    elements.gascloud.style.backgroundColor = `rgba(${red}, ${green}, 100, ${currentRisk / 150})`; 

                    // C. ç©åˆ†è¨ˆç®—èˆ‡çæ‡²
                    let currentRiskLevel = 'safe';
                    if (currentRisk >= HIGH_RISK_THRESHOLD) {
                        currentRiskLevel = 'high';
                    } else if (currentRisk >= MODERATE_RISK_THRESHOLD) {
                        currentRiskLevel = 'moderate';
                    } else if (currentRisk <= LOW_RISK_THRESHOLD) {
                        currentScore += LOW_RISK_BONUS * (UPDATE_INTERVAL / 1000);
                    }
                    
                    currentScore += 1 * (UPDATE_INTERVAL / 1000); 
                    
                    // æ‡‰è®Šçå‹µ
                    if ((previousRiskLevel === 'moderate' || previousRiskLevel === 'high') && currentRiskLevel === 'safe') {
                        currentScore += RESPONSE_BONUS;
                        elements.eventmessage.innerHTML = `<span style="color: green; font-weight: bold;">ğŸ‘ æ‡‰è®ŠæˆåŠŸï¼ç²å¾— ${RESPONSE_BONUS} çå‹µç©åˆ†ï¼</span>`;
                    }
                    previousRiskLevel = currentRiskLevel; 
                    elements.scoredisplay.textContent = Math.round(currentScore);
                    
                    // D. è­¦å‘Šèˆ‡äº‹ä»¶
                    elements.simulationpanel.classList.remove('alert-yellow', 'alert-red');
                    if (currentRisk >= EXPLOSION_THRESHOLD) {
                        endSimulation('fail'); 
                        elements.gascloud.classList.add('explosion');
                        return; 
                    } else if (currentRisk >= HIGH_RISK_THRESHOLD) {
                        elements.simulationpanel.classList.add('alert-red');
                        elements.eventmessage.innerHTML = `<span class="action-needed">ğŸ”´ é¢¨éšªæ¥µé«˜ï¼è«‹ç«‹åˆ» **æé«˜é€šé¢¨**ï¼</span>`;
                    } else if (currentRisk >= MODERATE_RISK_THRESHOLD) {
                        elements.simulationpanel.classList.add('alert-yellow');
                        elements.eventmessage.innerHTML = `<span class="action-needed">ğŸŸ¡ é¢¨éšªä¸­ç­‰ï¼è«‹æº–å‚™ **èª¿æ•´é€šé¢¨**ï¼</span>`;
                    }
                    
                    triggerFireEvent(currentRisk);
                    
                    lastUpdate = timestamp;
                }
            }

            // 5. ç¹¼çºŒä¸‹ä¸€å¹€
            animationFrameId = window.requestAnimationFrame(gameLoop);
        }

        // --- å‡½æ•¸ 10: å•Ÿå‹•æ¨¡æ“¬ (ç¶å®šåˆ°æŒ‰éˆ•) ---
        function startSimulation() {
            if (simulationActive) return;

            console.log('%c[V19.0: é–‹å§‹æ¨¡æ“¬] éŠæˆ²å•Ÿå‹•ä¸­...', 'color: blue; font-weight: bold;');
            
            simulationActive = true;
            elements.startsimulation.disabled = true;
            elements.resultspanel.classList.add('hidden');
            
            // ç¦ç”¨è¨­ç½®åƒæ•¸ï¼Œå•Ÿç”¨ç©å®¶å¯æ§åƒæ•¸
            allSliders.forEach(slider => {
                const input = document.getElementById(slider.id);
                if (slider.id === 'vent-system') {
                    input.disabled = false; 
                } else {
                    input.disabled = true; 
                }
            });
            
            // é‡ç½®æ‰€æœ‰ç‹€æ…‹
            burnCount = 0; 
            currentScore = 0;
            previousRiskLevel = 'safe'; 
            isHeatActive = false;

            elements.burncountdisplay.textContent = '0';
            elements.scoredisplay.textContent = '0';
            elements.timerdisplay.textContent = GAME_DURATION_SECONDS.toFixed(1);
            elements.eventmessage.textContent = 'å‹•æ…‹æ‡‰è®Šé–‹å§‹ï¼';
            elements.gascloud.classList.remove('explosion', 'flame');
            elements.simulationpanel.classList.remove('alert-yellow', 'alert-red');
            
            // åˆå§‹ Heat è¨­ç½®ç‚ºå¾…æ©Ÿ (1 ç´š)
            heatPowerInput.value = 1;
            document.getElementById('heat-power-val').textContent = `1 ç´š (å¾…æ©Ÿ)`;
            updateDashboardDisplays('heat-power', 1);

            // è¨­ç½®å•Ÿå‹•æ™‚é–“
            startTime = performance.now();
            lastUpdate = startTime;
            lastFartChange = startTime; 
            lastHeatCycle = startTime; 
            lastRandomEvent = startTime; 
        }

        // --- å‡½æ•¸ 11: çµæŸæ¨¡æ“¬èˆ‡å ±å‘Š ---
        function endSimulation(result) {
            simulationActive = false;
            elements.startsimulation.disabled = false;
            
            // æ¸…ç† rAF å¾ªç’°
            if (animationFrameId) {
                window.cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }

            // é‡æ–°å•Ÿç”¨æ‰€æœ‰æ»‘æ¡¿ä»¥ä¾¿é‡æ–°é–‹å§‹
            allSliders.forEach(s => {
                document.getElementById(s.id).disabled = false;
            });
            
            setTimeout(() => {
                elements.resultspanel.classList.remove('hidden');
            }, 100); 

            let resultText = '';
            let learningText = '';
            
            if (result === 'fail') {
                resultText = 'ğŸ’¥ **æ¨¡æ“¬å¤±æ•— (ç™¼ç”Ÿçˆ†ç‚¸)**ï¼æ‰‹è¡“å®¤ç’°å¢ƒè¶…è¼‰ã€‚';
                learningText = `**å¤±æ•—ç¸½çµï¼š** æ‚¨æœªèƒ½å°‡é¢¨éšª R_risk > 95 å‰æ§åˆ¶ä½ã€‚é›»ç‡’åˆ€é–“æ­‡æ€§ç™¼ç†±ï¼Œæ‚¨æ‡‰åœ¨ç™¼ç†±æ™‚é›†ä¸­ç²¾åŠ›èª¿é«˜é€šé¢¨ã€‚`;
                currentScore = 0; 
            } else {
                resultText = 'âœ… **å®‰å…¨é€šé**ï¼æˆåŠŸå®Œæˆ 45.0 ç§’æ‡‰è®ŠæŒ‘æˆ°ã€‚';
                
                if (burnCount === 0) {
                    learningText = `**ç¸½çµï¼š** æ‚¨è¡¨ç¾å‡ºè‰²ï¼Œå®Œç¾æ‡‰å°äº†å‹•æ…‹ç’°å¢ƒå’Œé–“æ­‡æ€§ç«æºï¼Œæ²’æœ‰ç™¼ç”Ÿä»»ä½•ç«èŠ±ï¼`;
                } else if (burnCount > 0) {
                     learningText = `**ç¸½çµï¼š** æ¨¡æ“¬ä¸­ç™¼ç”Ÿäº† ${burnCount} æ¬¡å°ç«èŠ±ã€‚æ‚¨æˆåŠŸå°‡é¢¨éšªæ§åˆ¶åœ¨çˆ†ç‚¸é–¾å€¼ä»¥ä¸‹ï¼Œç²å¾—äº† ${Math.round(currentScore)} é»å®‰å…¨ç©åˆ†ã€‚`;
                }
            }
            
            elements.finalresulttext.innerHTML = `<span class="${result === 'safe' ? 'success-text' : 'failure-text'}">${resultText}</span>`;
            elements.learningpoint.textContent = learningText;
            elements.finalburncount.textContent = burnCount;
            elements.finalscore.textContent = Math.round(currentScore);
            
            elements.simulationpanel.classList.remove('alert-yellow', 'alert-red');
        }


        // --- åˆå§‹åŒ–å…¥å£ ---
        window.onload = () => {
            if (getDOMElements()) {
                initializeSliders();
                
                if (elements.startsimulation) {
                    elements.startsimulation.addEventListener('click', startSimulation);
                }
                
                animationFrameId = window.requestAnimationFrame(gameLoop);
                console.log(`[V19.0: åˆå§‹åŒ–å®Œæˆ] éŠæˆ²å¾ªç’°å·²å•Ÿå‹• (è¨ˆæ™‚å™¨æ‡‰ç•¶éœæ­¢åœ¨ ${GAME_DURATION_SECONDS.toFixed(1)} ç§’)ã€‚è«‹é»æ“Š "é–‹å§‹æ‡‰è®Š" æŒ‰éˆ•ã€‚`);
            }
        };

    </script>
</body>
</html>